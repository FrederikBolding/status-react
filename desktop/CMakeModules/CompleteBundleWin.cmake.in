# windeployqt should be used here, but since we get the `Not implemented` error from it, we're trying to manually copy artifacts to output directory
set(TARGET_DIR $<TARGET_FILE_DIR:${APP_NAME}>)

#set(ENV{PATH} @QTROOT@/bin:$ENV{PATH})
#set(ENV{QT_PATH} @QTROOT@/..)
#message("SOURCE_ROOT=@SOURCE_ROOT@")
#message("APP_NAME=@APP_NAME@")
#message("CONAN_BIN_DIRS_QT5=@CONAN_BIN_DIRS_QT5@")
#message("CONAN_BIN_DIRS_STATUSTOOLCHAIN-X86_64-W64-MINGW32=@CONAN_BIN_DIRS_STATUSTOOLCHAIN-X86_64-W64-MINGW32@")

set(qtmodules Core Gui Widgets Qml Quick WebSockets Svg Network Concurrent)
foreach(qtmodule ${qtmodules})
  message("Copying ${qtmodule}")
  add_custom_command(TARGET @APP_NAME@ POST_BUILD
      COMMAND ${CMAKE_COMMAND} -E copy_if_different
          "@CONAN_BIN_DIRS_QT5@/Qt5${qtmodule}.dll"
          ${TARGET_DIR})
endforeach(qtmodule ${qtmodules})

set(qtplugindirs "platforms" "styles" "iconengines" "imageformats" "translations")
foreach(qtplugindir ${qtplugindirs})
  message("Copying ${qtplugindir}")
  add_custom_command(TARGET @APP_NAME@ POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_directory
        "@CONAN_BIN_DIRS_QT5@/../plugins/${qtplugindir}/"
        "${TARGET_DIR}/${qtplugindir}")
endforeach()

set(qtqmldirs "QtQuick" "QtQuick.2" "QtWebView")
foreach(qtqmldir ${qtqmldirs})
  message("Copying ${qtqmldir}")
  add_custom_command(TARGET @APP_NAME@ POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_directory
        "@CONAN_BIN_DIRS_QT5@/../qml/${qtqmldir}/"
        "${TARGET_DIR}/${qtqmldir}")
endforeach()

foreach(libdir @CONAN_BIN_DIRS_STATUSTOOLCHAIN-X86_64-W64-MINGW32@)
  if(EXISTS "${libdir}/libwinpthread-1.dll")
    add_custom_command(TARGET @APP_NAME@ POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${libdir}/libwinpthread-1.dll"
            ${TARGET_DIR})
    break()
  endif()
endforeach(libdir @CONAN_BIN_DIRS_STATUSTOOLCHAIN-X86_64-W64-MINGW32@)
